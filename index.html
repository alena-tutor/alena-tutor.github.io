<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Desk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      /* —Ç—ë–ø–ª—ã–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –ø—Ä–µ–º–∏—É–º-—Å—Ç–∏–ª—å (–∫–∞–∫ –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞) */
      --bg: #F6F5F3;
      --bg-alt: #ECEAE6;
      --card: #FFFFFF;
      --accent: #C7924B;       /* –∫–∞—Ä–∞–º–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
      --accent-soft: #EAD2B3;
      --text: #2F2B28;
      --muted: #7C756F;
      --border: #DDD5CC;
      --danger: #D9686F;
      --radius: 18px;
      --shadow: 0 12px 30px rgba(47, 43, 40, 0.06);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      min-height: 100vh;
      display: flex;
    }

    /* ---------- SIDEBAR (—à–∏—Ä–æ–∫–æ–µ –º–µ–Ω—é) ---------- */

    .sidebar {
      width: 260px;
      background: var(--bg-alt);
      border-right: 1px solid var(--border);
      padding: 22px 18px;
      display: flex;
      flex-direction: column;
      gap: 28px;
      box-shadow: 8px 0 28px rgba(47, 43, 40, 0.08);
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 4px;
    }

    .sidebar-logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: linear-gradient(135deg, #dca867, #c7924b);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 8px 16px rgba(199, 146, 75, 0.45);
    }

    .sidebar-logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-logo-title {
      font-weight: 700;
      font-size: 17px;
    }

    .sidebar-logo-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .sidebar-section-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 4px 4px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-btn {
      border-radius: 999px;
      border: none;
      padding: 10px 12px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      text-align: left;
      transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.08s ease;
    }

    .nav-btn span.icon {
      font-size: 16px;
      width: 22px;
      text-align: center;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text);
      box-shadow: 0 5px 12px rgba(47, 43, 40, 0.12);
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: linear-gradient(135deg, #dca867, #c7924b);
      color: #fff;
      box-shadow: 0 8px 18px rgba(199, 146, 75, 0.5);
    }

    .nav-btn.active span.icon {
      color: #fff;
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 10px 12px;
      font-size: 11px;
      color: var(--muted);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(221, 213, 204, 0.7);
    }

    /* ---------- MAIN PANEL ---------- */

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 22px;
      background: rgba(246, 245, 243, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(221, 213, 204, 0.8);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-date-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #todayLabel {
      font-size: 15px;
      font-weight: 600;
    }

    .header-timezone {
      font-size: 11px;
      color: var(--muted);
    }

    .header-timezone select {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fdfbf7;
    }

    .header-right {
      font-size: 11px;
      color: var(--muted);
    }

    /* ---------- CLOCK ---------- */

    .clock {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 2px solid var(--accent-soft);
      position: relative;
      background: var(--card);
      box-shadow:
        0 2px 6px rgba(0,0,0,0.06) inset,
        0 6px 14px rgba(47,43,40,0.12);
    }

    .clock-center {
      position: absolute;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }

    .clock-hand {
      position: absolute;
      left: 50%;
      transform-origin: bottom center;
      transform: translateX(-50%) rotate(0deg);
      border-radius: 999px;
    }

    .clock-hand.hour {
      width: 3px;
      height: 22px;
      bottom: 50%;
      background: var(--accent);
      z-index: 2;
    }

    .clock-hand.min {
      width: 2px;
      height: 28px;
      bottom: 50%;
      background: var(--text);
      z-index: 2;
    }

    .clock-hand.sec {
      width: 1px;
      height: 30px;
      bottom: 50%;
      background: var(--danger);
      z-index: 1;
    }

    .clock-num {
      position: absolute;
      font-size: 9px;
      color: var(--muted);
      transform: translate(-50%, -50%);
    }

    .clock-num.n12 { top: 8px; left: 50%; }
    .clock-num.n3 { top: 50%; right: 8px; transform: translate(50%, -50%); }
    .clock-num.n6 { bottom: 8px; left: 50%; }
    .clock-num.n9 { top: 50%; left: 8px; transform: translate(-50%, -50%); }

    /* ---------- CONTENT ---------- */

    main {
      flex: 1;
      padding: 16px 22px 22px;
    }

    #mainCol {
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 0;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      border: 1px solid rgba(221, 213, 204, 0.6);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-title {
      font-weight: 600;
      font-size: 15px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .tag {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: default;
      border: 1px solid rgba(199, 146, 75, 0.3);
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #6fbf73;
    }

    .empty-state {
      font-size: 12px;
      color: var(--muted);
      padding: 4px;
    }

    .btn-main {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      background: linear-gradient(135deg, #dca867, #c7924b);
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      box-shadow: 0 8px 18px rgba(199,146,75,0.55);
      transition: transform 0.08s ease, box-shadow 0.12s ease;
    }

    .btn-main:hover {
      box-shadow: 0 10px 22px rgba(199,146,75,0.65);
      transform: translateY(-1px);
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 7px 14px;
      background: #f6f2eb;
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
    }

    .btn-secondary:hover {
      background: #f0e7dd;
    }

    .btn-danger {
      border-radius: 999px;
      padding: 7px 14px;
      background: #f7d1d5;
      border: 1px solid #e4a7af;
      color: var(--danger);
      cursor: pointer;
      font-size: 13px;
    }

    .btn-chip {
      border-radius: 999px;
      border: none;
      padding: 3px 9px;
      font-size: 11px;
      cursor: pointer;
      background: var(--card);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.04);
    }

    .btn-chip.primary {
      background: linear-gradient(135deg, #dca867, #c7924b);
      color: #fff;
    }

    .btn-chip.danger {
      background: #f7d1d5;
      color: var(--danger);
    }

    .btn-chip.small {
      font-size: 10px;
      padding: 2px 7px;
    }

    .status-label {
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid rgba(0,0,0,0.04);
      font-size: 10px;
    }

    .status-done {
      background: #daf1dd;
      border-color: #c0e4c1;
    }

    .status-cancelled {
      background: #f6d6d6;
      border-color: #ebbbbb;
    }

    .tiny {
      font-size: 11px;
      color: var(--muted);
    }

    /* ---------- HOME LAYOUT ---------- */

    .home-grid {
      display: grid;
      grid-template-columns: 2.1fr 1.1fr;
      gap: 14px;
      align-items: flex-start;
    }

    .home-left {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .home-right {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .notes-area {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 13px;
      background: #fdfbf7;
    }

    .lesson-list {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .lesson-card {
      padding: 9px 9px;
      border-radius: 14px;
      background: #f4efe7;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(221, 213, 204, 0.7);
      transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease;
    }

    .lesson-card:hover {
      background: #f1e7da;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(47, 43, 40, 0.12);
    }

    .lesson-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .lesson-name {
      font-weight: 600;
    }

    .lesson-time {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .lesson-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .lesson-grades {
      font-size: 11px;
      display: flex;
      gap: 10px;
      color: var(--muted);
    }

    .lesson-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .summary-number {
      font-size: 26px;
      font-weight: 700;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 4px;
      color: var(--muted);
    }

    /* ---------- PERFORMANCE ---------- */

    .perf-row {
      display: grid;
      grid-template-columns: 1.4fr 0.6fr 1.5fr;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .perf-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #f2ebe2;
      overflow: hidden;
    }

    .perf-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #dca867, #c7924b);
      width: 0%;
    }

    .topics-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .topics-item {
      padding: 5px 7px;
      border-radius: 12px;
      background: #f4efe7;
      border: 1px solid rgba(221, 213, 204, 0.7);
    }

    /* ---------- CALENDAR ---------- */

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .calendar-day {
      border-radius: 14px;
      background: #f4efe7;
      padding: 6px;
      min-height: 95px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      border: 1px solid rgba(221, 213, 204, 0.8);
      transition: box-shadow 0.12s ease, transform 0.08s ease;
    }

    .calendar-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .calendar-lessons {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .calendar-mini {
      background: var(--card);
      border-radius: 9px;
      padding: 3px 4px;
      display: flex;
      flex-direction: column;
      gap: 1px;
      cursor: grab;
      border: 1px solid rgba(221, 213, 204, 0.8);
    }

    .calendar-mini.done {
      border-color: #b7ddb9;
      background: #e8f4ea;
    }

    .calendar-mini.cancelled {
      border-color: #e4b0b0;
      opacity: 0.6;
    }

    .calendar-mini .line1 {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
    }

    .calendar-mini .line2 {
      font-size: 10px;
      color: var(--muted);
    }

    .calendar-day.drop-target {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(199,146,75,0.35);
    }

    .calendar-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    /* ---------- FORMS ---------- */

    .form-section {
      border-radius: 14px;
      background: #f4efe7;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid rgba(221,213,204,0.8);
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-row-inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .form-row-inline > div {
      flex: 1;
      min-width: 140px;
    }

    .form-label {
      font-size: 11px;
      color: var(--muted);
    }

    .form-input, .form-select, textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 9px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: #fdfbf7;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    /* ---------- STUDENTS & SUBSCRIPTIONS ---------- */

    .students-list {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .student-card {
      border-radius: 14px;
      background: #f4efe7;
      padding: 7px 9px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      border: 1px solid rgba(221, 213, 204, 0.8);
      transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease;
    }

    .student-card:hover {
      background: #f1e7da;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(47,43,40,0.14);
    }

    .student-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }

    .student-name {
      font-weight: 600;
    }

    .subs-table-header,
    .subs-table-row {
      display: grid;
      grid-template-columns: 2fr 1.4fr 1.2fr 1.2fr 1.4fr 1.4fr;
      column-gap: 6px;
      align-items: center;
    }

    .subs-table-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    .subs-table-row {
      font-size: 12px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .subs-table-row:nth-child(odd) {
      background: rgba(255,255,255,0.3);
    }

  </style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">T</div>
      <div class="sidebar-logo-text">
        <div class="sidebar-logo-title">Teacher Desk</div>
        <div class="sidebar-logo-sub">–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</div>
      </div>
    </div>

    <div class="sidebar-section-label">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
    <nav class="sidebar-nav">
      <button class="nav-btn active" data-view="today">
        <span class="icon">üè†</span>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
      </button>
      <button class="nav-btn" data-view="calendar">
        <span class="icon">üìÜ</span>
        <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
      </button>
      <button class="nav-btn" data-view="students">
        <span class="icon">üë©‚Äçüéì</span>
        <span>–£—á–µ–Ω–∏–∫–∏</span>
      </button>
      <button class="nav-btn" data-view="subscriptions">
        <span class="icon">üí≥</span>
        <span>–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</span>
      </button>
      <button class="nav-btn" data-view="journal">
        <span class="icon">üìí</span>
        <span>–ñ—É—Ä–Ω–∞–ª</span>
      </button>
      <button class="nav-btn" data-view="settings">
        <span class="icon">‚öôÔ∏è</span>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </button>
      <button class="nav-btn" data-view="logout">
        <span class="icon">üö™</span>
        <span>–í—ã—Ö–æ–¥</span>
      </button>
    </nav>

    <div class="sidebar-footer">
      –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.  
      –ù–µ –æ—á–∏—â–∞–π –∫—ç—à, –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ üôÇ
    </div>
  </aside>

  <!-- MAIN PANEL -->
  <div class="main-panel">
    <header>
      <div class="header-left">
        <div class="clock">
          <div class="clock-num n12">12</div>
          <div class="clock-num n3">3</div>
          <div class="clock-num n6">6</div>
          <div class="clock-num n9">9</div>
          <div class="clock-center"></div>
          <div class="clock-hand hour" id="hourHand"></div>
          <div class="clock-hand min" id="minHand"></div>
          <div class="clock-hand sec" id="secHand"></div>
        </div>
        <div class="header-date-block">
          <div id="todayLabel"></div>
          <div class="header-timezone">
            –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:
            <select id="tutorTZ"></select>
          </div>
        </div>
      </div>
      <div class="header-right">
        –î–æ–º–∞—à–Ω–∏–π –∫–∞–±–∏–Ω–µ—Ç ‚Ä¢ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —É —Ç–µ–±—è
      </div>
    </header>

    <main>
      <div id="mainCol"></div>
    </main>
  </div>
</div>

<script>
  const STORAGE_KEY = "teacherAppData";

  const daysOfWeek = [
    { key: "mon", label: "–ü–Ω", dow: 1 },
    { key: "tue", label: "–í—Ç", dow: 2 },
    { key: "wed", label: "–°—Ä", dow: 3 },
    { key: "thu", label: "–ß—Ç", dow: 4 },
    { key: "fri", label: "–ü—Ç", dow: 5 },
    { key: "sat", label: "–°–±", dow: 6 },
    { key: "sun", label: "–í—Å", dow: 0 }
  ];

  const ALL_TZ = (typeof Intl.supportedValuesOf === "function" &&
                  Intl.supportedValuesOf("timeZone")) || [
    "Europe/Moscow","Asia/Irkutsk","Europe/Berlin","UTC"
  ];

  const defaultData = {
    tutorTZ: (Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Moscow"),
    students: [],
    lessons: [],
    subscriptions: [],
    weekNotes: ""
  };

  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
      return JSON.parse(JSON.stringify(defaultData));
    }
    try {
      const parsed = JSON.parse(raw);
      if (!parsed.tutorTZ) parsed.tutorTZ = defaultData.tutorTZ;
      if (!parsed.students) parsed.students = [];
      if (!parsed.lessons) parsed.lessons = [];
      if (!parsed.subscriptions) parsed.subscriptions = [];
      if (!parsed.weekNotes) parsed.weekNotes = "";

      // –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –∏—Ö –Ω–µ –±—ã–ª–æ
      parsed.students.forEach(s => {
        if (!("parentName" in s)) s.parentName = "";
        if (!("parentContact" in s)) s.parentContact = "";
        if (!("parentContactType" in s)) s.parentContactType = "phone";
      });

      parsed.subscriptions.forEach(s => {
        if (s.paid === undefined || s.paid === null) {
          s.paid = s.price || 0;
        }
        if (s.doneOffset === undefined || s.doneOffset === null) {
          s.doneOffset = 0;
        }
      });
      return parsed;
    } catch(e) {
      console.error(e);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
      return JSON.parse(JSON.stringify(defaultData));
    }
  }

  let data = loadData();

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    render();
  }

  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function parseISO(dateStr) {
    const [y,m,d] = dateStr.split("-").map(Number);
    return new Date(y,m-1,d);
  }

  function dateToISO(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function getStudent(id) {
    return data.students.find(s => s.id === id) || null;
  }

  function getLessonsByStudent(id) {
    return data.lessons.filter(l => l.studentId === id);
  }

  function getSubscription(studentId) {
    return data.subscriptions.find(s => s.studentId === studentId) || null;
  }

  function getSubscriptionStats(studentId){
    const lessons = getLessonsByStudent(studentId);
    const sub = getSubscription(studentId);
    const rawDone = lessons.filter(l=>l.status==="done").length;
    const offset = sub && sub.doneOffset ? sub.doneOffset : 0;
    const doneCount = rawDone + offset;
    const total = sub ? sub.total : 0;
    const remaining = sub ? Math.max(total - doneCount, 0) : 0;
    const price = sub ? (sub.price || 0) : 0;
    const paid  = sub ? (sub.paid  || 0) : 0;
    const debt  = Math.max(price - paid, 0);
    return {sub,lessons,rawDone,doneCount,total,remaining,price,paid,debt};
  }

  function createLesson(studentId,date,time) {
    const id = data.lessons.length ? Math.max(...data.lessons.map(l=>l.id))+1 : 1;
    const existing = data.lessons.find(l => l.studentId===studentId && l.date===date && l.time===time && l.status!=="cancelled");
    if (existing) return existing;
    const lesson = {
      id,
      studentId,
      date,
      time,
      status: "scheduled",
      topic: "",
      hw: "",
      gradeLesson: null,
      gradeHW: null,
      comment: "",
      commentLesson: "",
      commentHW: "",
      wasMoved: false
    };
    data.lessons.push(lesson);
    return lesson;
  }

  function autoCreateLessonsForStudent(student,weeks,startDate) {
    if (!student.schedule || !student.schedule.length) return;
    const base = startDate ? new Date(startDate) : new Date();
    base.setHours(0,0,0,0);
    const msWeek = 7*24*60*60*1000;

    student.schedule.forEach(slot => {
      if (!slot.time) return;
      const dow = daysOfWeek.find(d=>d.key===slot.dayKey)?.dow;
      if (dow == null) return;

      const first = new Date(base);
      let diff = (dow - first.getDay() + 7) % 7;
      first.setDate(first.getDate()+diff);

      for(let w=0; w<weeks; w++){
        const d = new Date(first.getTime() + w*msWeek);
        createLesson(student.id, dateToISO(d), slot.time);
      }
    });
  }

  function extendScheduleForStudent(studentId,weeks) {
    const student = getStudent(studentId);
    if (!student) { alert("–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }
    if (!student.schedule || !student.schedule.length) {
      alert("–î–ª—è —É—á–µ–Ω–∏–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.");
      return;
    }
    const lessons = getLessonsByStudent(studentId);
    let start;
    if (lessons.length) {
      const maxDateStr = lessons.reduce((max,l)=> !max || l.date>max ? l.date : max, "");
      const d = parseISO(maxDateStr);
      d.setDate(d.getDate()+1);
      start = d;
    } else {
      start = new Date();
    }
    autoCreateLessonsForStudent(student,weeks,start);
    save();
  }

  const hourHand = document.getElementById("hourHand");
  const minHand = document.getElementById("minHand");
  const secHand = document.getElementById("secHand");
  const tutorTZSelect = document.getElementById("tutorTZ");
  const todayLabel = document.getElementById("todayLabel");

  function updateClock() {
    const now = new Date();
    const s = now.getSeconds();
    const m = now.getMinutes();
    const h = now.getHours();
    secHand.style.transform = `translateX(-50%) rotate(${s*6}deg)`;
    minHand.style.transform = `translateX(-50%) rotate(${m*6 + s*0.1}deg)`;
    hourHand.style.transform = `translateX(-50%) rotate(${(h%12)*30 + m*0.5}deg)`;
  }
  setInterval(updateClock,1000);
  updateClock();

  function renderHeaderInfo() {
    tutorTZSelect.innerHTML="";
    ALL_TZ.forEach(tz=>{
      const opt=document.createElement("option");
      opt.value=tz;
      opt.textContent=tz;
      if (tz===data.tutorTZ) opt.selected=true;
      tutorTZSelect.appendChild(opt);
    });
    tutorTZSelect.onchange=()=>{
      data.tutorTZ=tutorTZSelect.value;
      save();
    };

    const now = new Date();
    const dateStr = new Intl.DateTimeFormat("ru-RU",{
      weekday:"long", day:"numeric", month:"long", timeZone:data.tutorTZ
    }).format(now);
    const timeStr = new Intl.DateTimeFormat("ru-RU",{
      hour:"2-digit", minute:"2-digit", timeZone:data.tutorTZ
    }).format(now);
    todayLabel.textContent = `${dateStr}, ${timeStr}`;
  }

  /* ---------- HOME (–ì–õ–ê–í–ù–ê–Ø) ---------- */

  function renderToday(main) {
    const container=document.createElement("div");
    container.className="home-grid";

    const leftCol=document.createElement("div");
    leftCol.className="home-left";

    // –∑–∞–º–µ—Ç–∫–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é
    const notesCard=document.createElement("section");
    notesCard.className="card";
    const nh=document.createElement("div");
    nh.className="card-header";
    const nhLeft=document.createElement("div");
    const ntitle=document.createElement("div");
    ntitle.className="card-title";
    ntitle.textContent="–ó–∞–º–µ—Ç–∫–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é";
    const nsub=document.createElement("div");
    nsub.className="card-subtitle";
    nsub.textContent="–ü–ª–∞–Ω—ã, –∏–¥–µ–∏, —á—Ç–æ –Ω–µ –∑–∞–±—ã—Ç—å —É—á–µ–Ω–∏–∫–∞–º –∏ —Å–µ–±–µ";
    nhLeft.appendChild(ntitle);
    nhLeft.appendChild(nsub);
    const nTag=document.createElement("div");
    nTag.className="tag";
    nTag.innerHTML='<span class="tag-dot"></span><span>—Ç–æ–ª—å–∫–æ —Ç—ã —ç—Ç–æ –≤–∏–¥–∏—à—å</span>';
    nh.appendChild(nhLeft);
    nh.appendChild(nTag);
    notesCard.appendChild(nh);

    const notesArea=document.createElement("textarea");
    notesArea.className="notes-area";
    notesArea.value=data.weekNotes || "";
    notesCard.appendChild(notesArea);

    const nActions=document.createElement("div");
    nActions.className="form-actions";
    const btnSaveNotes=document.createElement("button");
    btnSaveNotes.className="btn-secondary";
    btnSaveNotes.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏";
    btnSaveNotes.onclick=()=>{
      data.weekNotes = notesArea.value;
      save();
    };
    nActions.appendChild(btnSaveNotes);
    notesCard.appendChild(nActions);

    leftCol.appendChild(notesCard);

    // —É—Ä–æ–∫–∏ —Å–µ–≥–æ–¥–Ω—è
    const today = todayISO();
    const todays = data.lessons
      .filter(l=>l.date===today && l.status!=="cancelled")
      .sort((a,b)=>a.time.localeCompare(b.time));

    const lessonsCard=document.createElement("section");
    lessonsCard.className="card";
    const lHeader=document.createElement("div");
    lHeader.className="card-header";
    const lLeft=document.createElement("div");
    const lTitle=document.createElement("div");
    lTitle.className="card-title";
    lTitle.textContent="–£—Ä–æ–∫–∏ —Å–µ–≥–æ–¥–Ω—è";
    const lSub=document.createElement("div");
    lSub.className="card-subtitle";
    lSub.textContent="–°—Ç–∞—Ç—É—Å—ã, –±—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ —É—Ä–æ–∫–∞";
    lLeft.appendChild(lTitle);
    lLeft.appendChild(lSub);
    const lTag=document.createElement("div");
    lTag.className="tag";
    lTag.innerHTML='<span class="tag-dot"></span><span>—Ñ–æ–∫—É—Å –¥–Ω—è</span>';
    lHeader.appendChild(lLeft);
    lHeader.appendChild(lTag);
    lessonsCard.appendChild(lHeader);

    const list=document.createElement("div");
    list.className="lesson-list";

    if (!todays.length) {
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–ù–∞ —Å–µ–≥–æ–¥–Ω—è —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç.";
      list.appendChild(empty);
    } else {
      todays.forEach(l=>list.appendChild(renderLessonCard(l)));
    }

    lessonsCard.appendChild(list);
    leftCol.appendChild(lessonsCard);

    // –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
    const rightCol=document.createElement("div");
    rightCol.className="home-right";

    // –∫–∞—Ä—Ç–æ—á–∫–∞ "–°–µ–≥–æ–¥–Ω—è"
    const todayCard=document.createElement("section");
    todayCard.className="card";
    const tHeader=document.createElement("div");
    tHeader.className="card-header";
    const tLeft=document.createElement("div");
    const tTitle=document.createElement("div");
    tTitle.className="card-title";
    tTitle.textContent="–°–µ–≥–æ–¥–Ω—è";
    const tSub=document.createElement("div");
    tSub.className="card-subtitle";
    tSub.textContent="–ö—Ä–∞—Ç–∫–æ –ø–æ —É—Ä–æ–∫–∞–º –Ω–∞ –¥–µ–Ω—å";
    tLeft.appendChild(tTitle);
    tLeft.appendChild(tSub);
    tHeader.appendChild(tLeft);
    todayCard.appendChild(tHeader);

    const totalToday = todays.length;
    const doneToday = data.lessons.filter(l=>l.date===today && l.status==="done").length;
    const cancelledToday = data.lessons.filter(l=>l.date===today && l.status==="cancelled").length;
    const plannedToday = data.lessons.filter(l=>l.date===today && l.status==="scheduled").length;

    const number=document.createElement("div");
    number.className="summary-number";
    number.textContent=totalToday;
    todayCard.appendChild(number);

    const sr1=document.createElement("div");
    sr1.className="summary-row";
    sr1.innerHTML=`<span>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</span><span>${doneToday}</span>`;
    const sr2=document.createElement("div");
    sr2.className="summary-row";
    sr2.innerHTML=`<span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span><span>${plannedToday}</span>`;
    const sr3=document.createElement("div");
    sr3.className="summary-row";
    sr3.innerHTML=`<span>–û—Ç–º–µ–Ω–µ–Ω–æ</span><span>${cancelledToday}</span>`;

    todayCard.appendChild(sr1);
    todayCard.appendChild(sr2);
    todayCard.appendChild(sr3);
    rightCol.appendChild(todayCard);

    // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏
    const statsCard=document.createElement("section");
    statsCard.className="card";
    const sHeader=document.createElement("div");
    sHeader.className="card-header";
    const sLeft=document.createElement("div");
    const sTitle=document.createElement("div");
    sTitle.className="card-title";
    sTitle.textContent="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏";
    const sSub=document.createElement("div");
    sSub.className="card-subtitle";
    sSub.textContent="–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç–∞–∂ –ø–æ –æ—Ü–µ–Ω–∫–∞–º –∑–∞ —É—Ä–æ–∫ –∏ –î/–∑";
    sLeft.appendChild(sTitle);
    sLeft.appendChild(sSub);
    sHeader.appendChild(sLeft);
    statsCard.appendChild(sHeader);

    const perfContainer=document.createElement("div");

    const perfData = computePerformance();

    if (!perfData.length) {
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫.";
      perfContainer.appendChild(empty);
    } else {
      perfData.slice(0,5).forEach(item=>{
        const row=document.createElement("div");
        row.className="perf-row";

        const name=document.createElement("div");
        name.textContent=item.student.name;

        const perc=document.createElement("div");
        perc.textContent=item.percent + "%";

        const bar=document.createElement("div");
        bar.className="perf-bar";
        const fill=document.createElement("div");
        fill.className="perf-bar-fill";
        fill.style.width = item.percent + "%";
        bar.appendChild(fill);

        row.appendChild(name);
        row.appendChild(perc);
        row.appendChild(bar);

        perfContainer.appendChild(row);
      });
    }

    statsCard.appendChild(perfContainer);
    rightCol.appendChild(statsCard);

    // —Ç–µ–º—ã —Å–µ–≥–æ–¥–Ω—è
    const topicsCard=document.createElement("section");
    topicsCard.className="card";
    const h=document.createElement("div");
    h.className="card-header";
    const hLeft=document.createElement("div");
    const tt=document.createElement("div");
    tt.className="card-title";
    tt.textContent="–¢–µ–º—ã —Å–µ–≥–æ–¥–Ω—è";
    const ts=document.createElement("div");
    ts.className="card-subtitle";
    ts.textContent="–ö—Ç–æ –∏ —á—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–∞ –∑–∞–Ω—è—Ç–∏–∏";
    hLeft.appendChild(tt);
    hLeft.appendChild(ts);
    h.appendChild(hLeft);
    topicsCard.appendChild(h);

    const topicsList=document.createElement("div");
    topicsList.className="topics-list";

    if (!todays.length) {
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–°–µ–≥–æ–¥–Ω—è —Ç–µ–º –Ω–µ—Ç ‚Äî —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç.";
      topicsList.appendChild(empty);
    } else {
      todays.forEach(l=>{
        const st=getStudent(l.studentId);
        const item=document.createElement("div");
        item.className="topics-item";
        const topicText = l.topic && l.topic.trim() ? l.topic.trim() : "–¢–µ–º–∞ –µ—â—ë –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞";
        item.innerHTML =
          `<strong>${l.time}</strong> ‚Ä¢ ${st?st.name:"‚Äî"}<br>`+
          `<span class="tiny">${topicText}</span>`;
        topicsList.appendChild(item);
      });
    }

    topicsCard.appendChild(topicsList);
    rightCol.appendChild(topicsCard);

    container.appendChild(leftCol);
    container.appendChild(rightCol);
    main.appendChild(container);
  }

  function computePerformance() {
    const result=[];
    data.students.forEach(st=>{
      const lessons = getLessonsByStudent(st.id);
      let sum=0, count=0;
      lessons.forEach(l=>{
        if(l.gradeLesson!=null){ sum+=l.gradeLesson; count++; }
        if(l.gradeHW!=null){ sum+=l.gradeHW; count++; }
      });
      if(count>0){
        const avg = sum / count;
        let percent = Math.round(avg / 5 * 100);
        if(percent>100) percent=100;
        result.push({student:st, avg, percent});
      }
    });
    result.sort((a,b)=>b.avg-a.avg);
    return result;
  }

  function renderLessonCard(lesson) {
    const st=getStudent(lesson.studentId);
    const el=document.createElement("div");
    el.className="lesson-card";
    el.onclick=()=>openLessonView(lesson.id);

    const top=document.createElement("div");
    top.className="lesson-top";
    const name=document.createElement("div");
    name.className="lesson-name";
    name.textContent = st ? st.name : "‚Äî";
    const time=document.createElement("div");
    time.className="lesson-time";
    time.textContent=lesson.time;
    top.appendChild(name);
    top.appendChild(time);

    const meta=document.createElement("div");
    meta.className="lesson-meta";
    const statusSpan=document.createElement("span");
    statusSpan.className="status-label";
    if (lesson.status==="done"){
      statusSpan.classList.add("status-done");
      statusSpan.textContent="–ø—Ä–æ–≤–µ–¥—ë–Ω";
    } else if (lesson.status==="cancelled"){
      statusSpan.classList.add("status-cancelled");
      statusSpan.textContent="–æ—Ç–º–µ–Ω—ë–Ω";
    } else statusSpan.textContent="–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω";

    const hwSpan=document.createElement("span");
    hwSpan.textContent = (lesson.hw && lesson.hw.trim()) ? "–î–æ–º–∞—à–∫–∞ –µ—Å—Ç—å" : "–î–æ–º–∞—à–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞";

    meta.appendChild(hwSpan);
    meta.appendChild(statusSpan);

    const grades=document.createElement("div");
    grades.className="lesson-grades";
    const gl = lesson.gradeLesson!=null?lesson.gradeLesson:"‚Äî";
    const gh = lesson.gradeHW!=null?lesson.gradeHW:"‚Äî";
    const glSpan=document.createElement("span");
    glSpan.textContent = "–£—Ä–æ–∫: "+gl;
    const ghSpan=document.createElement("span");
    ghSpan.textContent = "–î–æ–º–∞—à–∫–∞: "+gh;
    grades.appendChild(glSpan);
    grades.appendChild(ghSpan);

    const actions=document.createElement("div");
    actions.className="lesson-actions";

    const btnDone=document.createElement("button");
    btnDone.className="btn-chip primary";
    btnDone.textContent="‚úÖ –ë—ã–ª —É—Ä–æ–∫";
    btnDone.onclick=(e)=>{e.stopPropagation(); setLessonStatus(lesson.id,"done");};

    const btnCancel=document.createElement("button");
    btnCancel.className="btn-chip danger";
    btnCancel.textContent="‚úñ –û—Ç–º–µ–Ω—ë–Ω";
    btnCancel.onclick=(e)=>{e.stopPropagation(); setLessonStatus(lesson.id,"cancelled");};

    const btnOpen=document.createElement("button");
    btnOpen.className="btn-chip";
    btnOpen.textContent="üìñ –û—Ç–∫—Ä—ã—Ç—å";
    btnOpen.onclick=(e)=>{e.stopPropagation(); openLessonView(lesson.id);};

    actions.appendChild(btnDone);
    actions.appendChild(btnCancel);
    actions.appendChild(btnOpen);

    el.appendChild(top);
    el.appendChild(meta);
    el.appendChild(grades);
    el.appendChild(actions);
    return el;
  }

  function setLessonStatus(id,status){
    const l=data.lessons.find(x=>x.id===id);
    if(!l) return;
    l.status=status;
    save();
  }

  /* ---------- CALENDAR ---------- */

  let currentMonthDate = new Date();

  function renderCalendar(main){
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–ö–∞–ª–µ–Ω–¥–∞—Ä—å";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π —É—Ä–æ–∫–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞. –ö–ª–∏–∫ –ø–æ —É—Ä–æ–∫—É ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞.";
    left.appendChild(title);
    left.appendChild(subtitle);

    const controls=document.createElement("div");
    controls.className="calendar-controls";
    const btnPrev=document.createElement("button");
    btnPrev.className="btn-secondary";
    btnPrev.textContent="‚óÄ";
    btnPrev.onclick=()=>{currentMonthDate.setMonth(currentMonthDate.getMonth()-1);render();};
    const btnNext=document.createElement("button");
    btnNext.className="btn-secondary";
    btnNext.textContent="‚ñ∂";
    btnNext.onclick=()=>{currentMonthDate.setMonth(currentMonthDate.getMonth()+1);render();};
    const label=document.createElement("span");
    label.textContent=currentMonthDate.toLocaleDateString("ru-RU",{month:"long",year:"numeric"});
    controls.appendChild(btnPrev);
    controls.appendChild(label);
    controls.appendChild(btnNext);

    header.appendChild(left);
    header.appendChild(controls);
    card.appendChild(header);

    const grid=document.createElement("div");
    grid.className="calendar-grid";

    const first = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(),1);
    const startDay = (first.getDay()+6)%7;
    let d = new Date(first);
    d.setDate(d.getDate()-startDay);

    for(let i=0;i<35;i++){
      const iso=dateToISO(d);
      const col=document.createElement("div");
      col.className="calendar-day";
      col.dataset.date=iso;

      col.addEventListener("dragover",e=>{
        e.preventDefault();
        col.classList.add("drop-target");
      });
      col.addEventListener("dragleave",()=>col.classList.remove("drop-target"));
      col.addEventListener("drop",e=>{
        e.preventDefault();
        col.classList.remove("drop-target");
        const idStr=e.dataTransfer.getData("text/plain");
        const id=parseInt(idStr,10);
        if(!id) return;
        moveLessonDate(id,iso);
      });

      const head=document.createElement("div");
      head.className="calendar-day-header";
      const dayNum=document.createElement("span");
      dayNum.textContent=d.getDate();
      const short=document.createElement("span");
      short.className="tiny";
      short.textContent=["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"][(d.getDay()+6)%7];
      head.appendChild(dayNum);
      head.appendChild(short);
      col.appendChild(head);

      const list=document.createElement("div");
      list.className="calendar-lessons";
      const lessons=data.lessons
        .filter(l=>l.date===iso && l.status!=="cancelled")
        .sort((a,b)=>a.time.localeCompare(b.time));
      if (!lessons.length){
        const tiny=document.createElement("div");
        tiny.className="tiny";
        tiny.textContent="‚Äî";
        list.appendChild(tiny);
      } else {
        lessons.forEach(l=>{
          const st=getStudent(l.studentId);
          const mini=document.createElement("div");
          mini.className="calendar-mini";
          if(l.status==="done") mini.classList.add("done");
          if(l.status==="cancelled") mini.classList.add("cancelled");
          mini.draggable=true;
          mini.addEventListener("dragstart",e=>{
            e.dataTransfer.setData("text/plain",String(l.id));
          });
          mini.onclick=()=>openLessonView(l.id);

          const line1=document.createElement("div");
          line1.className="line1";
          const tSpan=document.createElement("span");
          tSpan.textContent=l.time;
          const nSpan=document.createElement("span");
          nSpan.textContent=st?st.name:"‚Äî";
          line1.appendChild(tSpan);
          line1.appendChild(nSpan);

          const line2=document.createElement("div");
          line2.className="line2";
          line2.textContent=l.topic || "";

          mini.appendChild(line1);
          mini.appendChild(line2);
          list.appendChild(mini);
        });
      }

      col.appendChild(list);

      const addBtn=document.createElement("button");
      addBtn.className="btn-chip small";
      addBtn.textContent="+ —É—Ä–æ–∫";
      addBtn.onclick=()=>openAddLessonForDate(iso);
      col.appendChild(addBtn);

      grid.appendChild(col);
      d.setDate(d.getDate()+1);
    }

    card.appendChild(grid);
    main.appendChild(card);
  }

  function moveLessonDate(lessonId,newDate){
    const l=data.lessons.find(x=>x.id===lessonId);
    if(!l) return;
    l.date=newDate;
    l.wasMoved=true;
    save();
  }

  function openAddLessonForDate(dateStr){
    const name = prompt("–ò–º—è —É—á–µ–Ω–∏–∫–∞ (–∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ)", "");
    if(!name) return;
    const student = data.students.find(s=>s.name.trim()===name.trim());
    if(!student){alert("–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.");return;}
    const time=prompt("–í—Ä–µ–º—è (–ß–ß:–ú–ú)", "18:00");
    if(!time) return;
    createLesson(student.id,dateStr,time);
    save();
  }

  /* ---------- STUDENTS LIST ---------- */

  let showAddStudentForm = false;

  function renderStudents(main){
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–£—á–µ–Ω–∏–∫–∏";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–ö–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã";
    left.appendChild(title);
    left.appendChild(subtitle);
    const btnToggle=document.createElement("button");
    btnToggle.className="btn-main";
    btnToggle.textContent = showAddStudentForm ? "–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É" : "–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞";
    btnToggle.onclick=()=>{showAddStudentForm=!showAddStudentForm;render();};
    header.appendChild(left);
    header.appendChild(btnToggle);
    card.appendChild(header);

    if (showAddStudentForm) {
      card.appendChild(renderAddStudentForm());
    }

    const list=document.createElement("div");
    list.className="students-list";
    if (!data.students.length){
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–ü–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.";
      list.appendChild(empty);
    } else {
      data.students.forEach(st=>{
        const {doneCount,total,remaining} = getSubscriptionStats(st.id);
        const lessons=getLessonsByStudent(st.id);

        const el=document.createElement("div");
        el.className="student-card";
        el.onclick=()=>openStudentView(st.id);

        const top=document.createElement("div");
        top.className="student-top";
        const name=document.createElement("div");
        name.className="student-name";
        name.textContent=st.name;
        const tz=document.createElement("div");
        tz.className="tiny";
        tz.textContent=st.tz || data.tutorTZ;
        top.appendChild(name);
        top.appendChild(tz);

        const contact=document.createElement("div");
        contact.className="tiny";
        if (st.contact) contact.textContent=`–£—á.: ${st.contactType||"phone"}: ${st.contact}`;
        else contact.textContent="–ö–æ–Ω—Ç–∞–∫—Ç —É—á–µ–Ω–∏–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω";

        const pContact=document.createElement("div");
        pContact.className="tiny";
        if(st.parentName || st.parentContact){
          pContact.textContent =
            `–†–æ–¥–∏—Ç–µ–ª—å: ${st.parentName || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"} `+
            (st.parentContact ? `(${st.parentContactType||"phone"}: ${st.parentContact})` : "");
        } else {
          pContact.textContent="–†–æ–¥–∏—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω";
        }

        const sch=document.createElement("div");
        sch.className="tiny";
        if (st.schedule && st.schedule.length){
          const text = st.schedule.map(s=>{
            const d=daysOfWeek.find(x=>x.key===s.dayKey)?.label || "?";
            return `${d} ${s.time||""}`;
          }).join(", ");
          sch.textContent="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: "+text;
        } else sch.textContent="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ";

        const {remaining:rem} = getSubscriptionStats(st.id);
        const subInfo=document.createElement("div");
        subInfo.className="tiny";
        if (rem || rem===0){
          subInfo.textContent = `–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç–∏–π –ø–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É: ${rem}`;
        } else {
          subInfo.textContent = "–ê–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω";
        }

        const info=document.createElement("div");
        info.className="tiny";
        info.textContent=`–£—Ä–æ–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: ${lessons.length}`;

        const rowBtns=document.createElement("div");
        rowBtns.style.display="flex";
        rowBtns.style.gap="4px";
        rowBtns.style.marginTop="4px";
        rowBtns.style.justifyContent="flex-end";

        const btnLessons=document.createElement("button");
        btnLessons.className="btn-chip small";
        btnLessons.textContent="–£—Ä–æ–∫–∏";
        btnLessons.onclick=(e)=>{e.stopPropagation(); openStudentView(st.id);};

        const btnEdit=document.createElement("button");
        btnEdit.className="btn-chip small";
        btnEdit.textContent="–ò–∑–º–µ–Ω–∏—Ç—å";
        btnEdit.onclick=(e)=>{e.stopPropagation(); openEditStudent(st.id);};

        const btnDel=document.createElement("button");
        btnDel.className="btn-chip small danger";
        btnDel.textContent="–£–¥–∞–ª–∏—Ç—å";
        btnDel.onclick=(e)=>{e.stopPropagation(); deleteStudent(st.id);};

        rowBtns.appendChild(btnLessons);
        rowBtns.appendChild(btnEdit);
        rowBtns.appendChild(btnDel);

        el.appendChild(top);
        el.appendChild(contact);
        el.appendChild(pContact);
        el.appendChild(sch);
        el.appendChild(subInfo);
        el.appendChild(info);
        if (st.notes) {
          const notes=document.createElement("div");
          notes.className="tiny";
          notes.textContent=st.notes;
          el.appendChild(notes);
        }
        el.appendChild(rowBtns);

        list.appendChild(el);
      });
    }

    card.appendChild(list);
    main.appendChild(card);
  }

  function renderAddStudentForm(){
    const form=document.createElement("div");
    form.className="form-section";

    // —É—á–µ–Ω–∏–∫: –∏–º—è + –∫–æ–Ω—Ç–∞–∫—Ç
    const row1=document.createElement("div");
    row1.className="form-row-inline";

    const colName=document.createElement("div");
    const lblName=document.createElement("div");
    lblName.className="form-label";
    lblName.textContent="–§–ò —É—á–µ–Ω–∏–∫–∞";
    const inName=document.createElement("input");
    inName.className="form-input";
    colName.appendChild(lblName);
    colName.appendChild(inName);

    const colContact=document.createElement("div");
    const lblContact=document.createElement("div");
    lblContact.className="form-label";
    lblContact.textContent="–ö–æ–Ω—Ç–∞–∫—Ç —É—á–µ–Ω–∏–∫–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @username)";
    const inContact=document.createElement("input");
    inContact.className="form-input";
    colContact.appendChild(lblContact);
    colContact.appendChild(inContact);

    row1.appendChild(colName);
    row1.appendChild(colContact);

    // —Ä–æ–¥–∏—Ç–µ–ª—å: –§–ò + –∫–æ–Ω—Ç–∞–∫—Ç
    const rowParent=document.createElement("div");
    rowParent.className="form-row-inline";

    const colPName=document.createElement("div");
    const lblPName=document.createElement("div");
    lblPName.className="form-label";
    lblPName.textContent="–§–ò —Ä–æ–¥–∏—Ç–µ–ª—è";
    const inPName=document.createElement("input");
    inPName.className="form-input";
    colPName.appendChild(lblPName);
    colPName.appendChild(inPName);

    const colPContact=document.createElement("div");
    const lblPContact=document.createElement("div");
    lblPContact.className="form-label";
    lblPContact.textContent="–ö–æ–Ω—Ç–∞–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª—è (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @username)";
    const inPContact=document.createElement("input");
    inPContact.className="form-input";
    colPContact.appendChild(lblPContact);
    colPContact.appendChild(inPContact);

    rowParent.appendChild(colPName);
    rowParent.appendChild(colPContact);

    // —Ç–∏–ø—ã –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ + TZ
    const row2=document.createElement("div");
    row2.className="form-row-inline";

    const colCT=document.createElement("div");
    const lblCT=document.createElement("div");
    lblCT.className="form-label";
    lblCT.textContent="–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞ —É—á–µ–Ω–∏–∫–∞";
    const selCT=document.createElement("select");
    selCT.className="form-select";
    [["phone","–ø—Ä–æ—Å—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω"],["whatsapp","WhatsApp"],["telegram","Telegram"]]
      .forEach(([val,txt])=>{
        const opt=document.createElement("option");
        opt.value=val;
        opt.textContent=txt;
        selCT.appendChild(opt);
      });
    colCT.appendChild(lblCT);
    colCT.appendChild(selCT);

    const colPCT=document.createElement("div");
    const lblPCT=document.createElement("div");
    lblPCT.className="form-label";
    lblPCT.textContent="–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—è";
    const selPCT=document.createElement("select");
    selPCT.className="form-select";
    [["phone","–ø—Ä–æ—Å—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω"],["whatsapp","WhatsApp"],["telegram","Telegram"]]
      .forEach(([val,txt])=>{
        const opt=document.createElement("option");
        opt.value=val;
        opt.textContent=txt;
        selPCT.appendChild(opt);
      });
    colPCT.appendChild(lblPCT);
    colPCT.appendChild(selPCT);

    const colTZ=document.createElement("div");
    const lblTZ=document.createElement("div");
    lblTZ.className="form-label";
    lblTZ.textContent="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —É—á–µ–Ω–∏–∫–∞";
    const selTZ=document.createElement("select");
    selTZ.className="form-select";
    ALL_TZ.forEach(tz=>{
      const opt=document.createElement("option");
      opt.value=tz;
      opt.textContent=tz;
      if (tz===data.tutorTZ) opt.selected=true;
      selTZ.appendChild(opt);
    });
    colTZ.appendChild(lblTZ);
    colTZ.appendChild(selTZ);

    row2.appendChild(colCT);
    row2.appendChild(colPCT);
    row2.appendChild(colTZ);

    const rowSchedule=document.createElement("div");
    rowSchedule.className="form-row";
    const lblSch=document.createElement("div");
    lblSch.className="form-label";
    lblSch.textContent="–î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º—è (–¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ä–æ–∫–æ–≤)";
    const daysWrap=document.createElement("div");
    daysWrap.style.display="flex";
    daysWrap.style.flexWrap="wrap";
    daysWrap.style.gap="6px";

    const schedControls=[];
    daysOfWeek.forEach(d=>{
      const box=document.createElement("div");
      box.style.display="flex";
      box.style.alignItems="center";
      box.style.gap="4px";
      box.style.fontSize="11px";
      const cb=document.createElement("input");
      cb.type="checkbox";
      const label=document.createElement("span");
      label.textContent=d.label;
      const time=document.createElement("input");
      time.type="time";
      time.style.width="80px";
      box.appendChild(cb);
      box.appendChild(label);
      box.appendChild(time);
      daysWrap.appendChild(box);
      schedControls.push({dayKey:d.key, cb, time});
    });

    rowSchedule.appendChild(lblSch);
    rowSchedule.appendChild(daysWrap);

    const rowSub=document.createElement("div");
    rowSub.className="form-row-inline";

    const colPrice=document.createElement("div");
    const lblPrice=document.createElement("div");
    lblPrice.className="form-label";
    lblPrice.textContent="–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞";
    const inPrice=document.createElement("input");
    inPrice.className="form-input";
    inPrice.type="number";
    inPrice.min="0";
    inPrice.placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 4000";
    colPrice.appendChild(lblPrice);
    colPrice.appendChild(inPrice);

    const colTotal=document.createElement("div");
    const lblTotal=document.createElement("div");
    lblTotal.className="form-label";
    lblTotal.textContent="–ó–∞–Ω—è—Ç–∏–π –≤ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–µ";
    const inTotal=document.createElement("input");
    inTotal.className="form-input";
    inTotal.type="number";
    inTotal.min="1";
    inTotal.placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 8";
    colTotal.appendChild(lblTotal);
    colTotal.appendChild(inTotal);

    const colNextPay=document.createElement("div");
    const lblNextPay=document.createElement("div");
    lblNextPay.className="form-label";
    lblNextPay.textContent="–°–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞ (–¥–∞—Ç–∞)";
    const inNextPay=document.createElement("input");
    inNextPay.className="form-input";
    inNextPay.type="date";
    colNextPay.appendChild(lblNextPay);
    colNextPay.appendChild(inNextPay);

    rowSub.appendChild(colPrice);
    rowSub.appendChild(colTotal);
    rowSub.appendChild(colNextPay);

    const rowDur=document.createElement("div");
    rowDur.className="form-row-inline";

    const colDur=document.createElement("div");
    const lblDur=document.createElement("div");
    lblDur.className="form-label";
    lblDur.textContent="–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–∏–æ–¥";
    const selDur=document.createElement("select");
    selDur.className="form-select";
    [
      {val:"month",txt:"1 –º–µ—Å—è—Ü"},
      {val:"halfyear",txt:"–ü–æ–ª–≥–æ–¥–∞"},
      {val:"year",txt:"–ì–æ–¥"}
    ].forEach(o=>{
      const opt=document.createElement("option");
      opt.value=o.val;
      opt.textContent=o.txt;
      selDur.appendChild(opt);
    });
    colDur.appendChild(lblDur);
    colDur.appendChild(selDur);
    rowDur.appendChild(colDur);

    const actions=document.createElement("div");
    actions.className="form-actions";
    const btnSave=document.createElement("button");
    btnSave.className="btn-main";
    btnSave.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—á–µ–Ω–∏–∫–∞";
    btnSave.onclick=()=>{
      const name=inName.value.trim();
      const contact=inContact.value.trim();
      if(!name){alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞");return;}
      if(!contact){alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç —É—á–µ–Ω–∏–∫–∞");return;}

      const schedule=[];
      schedControls.forEach(s=>{
        if(s.cb.checked){
          schedule.push({dayKey:s.dayKey,time:s.time.value||"18:00"});
        }
      });

      const id=data.students.length?Math.max(...data.students.map(s=>s.id))+1:1;
      const student={
        id,
        name,
        contactType: selCT.value,
        contact,
        parentName: inPName.value.trim() || "",
        parentContactType: selPCT.value,
        parentContact: inPContact.value.trim() || "",
        tz: selTZ.value,
        schedule: schedule.length?schedule:null,
        notes:""
      };
      data.students.push(student);

      const priceVal = inPrice.value ? parseFloat(inPrice.value) : 0;
      const totalVal = inTotal.value ? parseInt(inTotal.value,10) : 0;
      const nextPayVal = inNextPay.value || "";

      if (totalVal>0 || priceVal>0 || nextPayVal) {
        const subId = data.subscriptions.length
          ? Math.max(...data.subscriptions.map(s=>s.id))+1
          : 1;
        data.subscriptions.push({
          id: subId,
          studentId: id,
          total: totalVal,
          price: priceVal,
          paid: priceVal,
          nextPaymentDate: nextPayVal,
          doneOffset: 0
        });
      }

      let weeks=4;
      if (selDur.value==="halfyear") weeks=26;
      else if (selDur.value==="year") weeks=52;
      if (student.schedule) autoCreateLessonsForStudent(student,weeks);

      save();
      showAddStudentForm=false;
      alert("–£—á–µ–Ω–∏–∫ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ.");
    };

    const btnClear=document.createElement("button");
    btnClear.className="btn-secondary";
    btnClear.textContent="–û—á–∏—Å—Ç–∏—Ç—å";
    btnClear.onclick=()=>{
      inName.value="";
      inContact.value="";
      inPName.value="";
      inPContact.value="";
      inPrice.value="";
      inTotal.value="";
      inNextPay.value="";
      schedControls.forEach(s=>{s.cb.checked=false; s.time.value="";});
    };

    actions.appendChild(btnSave);
    actions.appendChild(btnClear);

    form.appendChild(row1);
    form.appendChild(rowParent);
    form.appendChild(row2);
    form.appendChild(rowSchedule);
    form.appendChild(rowSub);
    form.appendChild(rowDur);
    form.appendChild(actions);
    return form;
  }

  function deleteStudent(id){
    if(!confirm("–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ –∏ –≤—Å–µ –µ–≥–æ —É—Ä–æ–∫–∏ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç?")) return;
    data.students = data.students.filter(s=>s.id!==id);
    data.lessons = data.lessons.filter(l=>l.studentId!==id);
    data.subscriptions = data.subscriptions.filter(s=>s.studentId!==id);
    save();
  }

  /* ---------- STUDENT VIEW + EDIT ---------- */

  let currentView="today";
  let currentStudentId=null;
  let currentLessonId=null;
  let currentSubscriptionStudentId=null;
  let journalFilterStudentId="all";

  function openStudentView(studentId){
    currentView="student";
    currentStudentId=studentId;
    render();
  }

  function editSubscription(studentId){
    currentView="subscriptionEdit";
    currentSubscriptionStudentId=studentId;
    render();
  }

  function renderStudent(main,studentId){
    const st=getStudent(studentId);
    if(!st){
      const card=document.createElement("section");
      card.className="card";
      card.textContent="–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.";
      main.appendChild(card);
      return;
    }
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent=st.name;
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent = st.tz ? `–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${st.tz}` : "";
    left.appendChild(title);
    left.appendChild(subtitle);

    const btnRow=document.createElement("div");
    btnRow.style.display="flex";
    btnRow.style.gap="6px";
    btnRow.style.flexWrap="wrap";

    const btnBack=document.createElement("button");
    btnBack.className="btn-secondary";
    btnBack.textContent="‚Üê –ö —É—á–µ–Ω–∏–∫–∞–º";
    btnBack.onclick=()=>{currentView="students";render();};

    const btnExtend=document.createElement("button");
    btnExtend.className="btn-main";
    btnExtend.textContent="–ü—Ä–æ–¥–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ";
    btnExtend.onclick=()=>{
      const choice=prompt("–ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞: 1 ‚Äî –º–µ—Å—è—Ü, 2 ‚Äî –ø–æ–ª–≥–æ–¥–∞, 3 ‚Äî –≥–æ–¥","1");
      let weeks=4;
      if(choice==="2") weeks=26;
      else if(choice==="3") weeks=52;
      extendScheduleForStudent(studentId,weeks);
    };

    const btnAdd=document.createElement("button");
    btnAdd.className="btn-secondary";
    btnAdd.textContent="–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫";
    btnAdd.onclick=()=>{
      const date=prompt("–î–∞—Ç–∞ (–ì–ì–ì–ì-–ú–ú-–î–î)", todayISO());
      if(!date) return;
      const time=prompt("–í—Ä–µ–º—è (–ß–ß:–ú–ú)", "18:00");
      if(!time) return;
      createLesson(studentId,date,time);
      save();
    };

    const btnEdit=document.createElement("button");
    btnEdit.className="btn-secondary";
    btnEdit.textContent="–ò–∑–º–µ–Ω–∏—Ç—å";
    btnEdit.onclick=()=>openEditStudent(studentId);

    btnRow.appendChild(btnBack);
    btnRow.appendChild(btnExtend);
    btnRow.appendChild(btnAdd);
    btnRow.appendChild(btnEdit);

    header.appendChild(left);
    header.appendChild(btnRow);
    card.appendChild(header);

    const contactInfo=document.createElement("div");
    contactInfo.className="tiny";
    contactInfo.innerHTML =
      `–£—á–µ–Ω–∏–∫: ${st.contact ? `${st.contactType||"—Ç–µ–ª–µ—Ñ–æ–Ω"}: ${st.contact}` : "–∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω"}<br>`+
      `–†–æ–¥–∏—Ç–µ–ª—å: ${
        st.parentName || st.parentContact
          ? (st.parentName || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ") +
            (st.parentContact ? ` (${st.parentContactType||"—Ç–µ–ª–µ—Ñ–æ–Ω"}: ${st.parentContact})` : "")
          : "–Ω–µ —É–∫–∞–∑–∞–Ω"
      }`;
    card.appendChild(contactInfo);

    const {sub,lessons,doneCount,total,remaining,price,paid,debt} = getSubscriptionStats(studentId);

    const info=document.createElement("div");
    info.className="tiny";
    info.textContent = st.schedule && st.schedule.length
      ? "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: " + st.schedule.map(s=>{
          const d = daysOfWeek.find(x=>x.key===s.dayKey)?.label || "?";
          return `${d} ${s.time||""}`;
        }).join(", ")
      : "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ.";
    card.appendChild(info);

    const subBlock=document.createElement("div");
    subBlock.className="form-section";
    const subTitle=document.createElement("div");
    subTitle.className="card-title";
    subTitle.style.fontSize="13px";
    subTitle.textContent="–ê–±–æ–Ω–µ–º–µ–Ω—Ç";
    const subText=document.createElement("div");
    subText.className="tiny";
    if(sub){
      subText.innerHTML =
        `<strong>–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç–∏–π: ${remaining}</strong> (–ø—Ä–æ—à–ª–∏ ${doneCount} –∏–∑ ${total})<br>`+
        `–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞: <strong>${price}</strong> ‚ÇΩ<br>`+
        `–û–ø–ª–∞—á–µ–Ω–æ: <strong>${paid}</strong> ‚ÇΩ`+
        (debt>0?` (–¥–æ–ª–≥: <strong>${debt}</strong> ‚ÇΩ)`:"")+
        `<br>–°–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞: <strong>${sub.nextPaymentDate || "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</strong>`;
    } else {
      subText.textContent="–ê–±–æ–Ω–µ–º–µ–Ω—Ç –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.";
    }
    const subBtn=document.createElement("button");
    subBtn.className="btn-secondary";
    subBtn.textContent="–ò–∑–º–µ–Ω–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç";
    subBtn.style.marginTop="6px";
    subBtn.onclick=()=>editSubscription(studentId);

    subBlock.appendChild(subTitle);
    subBlock.appendChild(subText);
    subBlock.appendChild(subBtn);
    card.appendChild(subBlock);

    const list=document.createElement("div");
    list.className="lesson-list";

    if(!lessons.length){
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–£ —ç—Ç–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤.";
      list.appendChild(empty);
    } else {
      lessons
        .sort((a,b)=> a.date===b.date ? a.time.localeCompare(b.time) : a.date.localeCompare(b.date))
        .forEach(l=>{
          const item=document.createElement("div");
          item.className="lesson-card";
          item.onclick=()=>openLessonView(l.id);
          const top=document.createElement("div");
          top.className="lesson-top";
          const dSpan=document.createElement("span");
          dSpan.textContent=`${l.date} ${l.time}`;
          const status=document.createElement("span");
          status.className="status-label";
          if(l.status==="done"){status.classList.add("status-done");status.textContent="–ø—Ä–æ–≤–µ–¥—ë–Ω";}
          else if(l.status==="cancelled"){status.classList.add("status-cancelled");status.textContent="–æ—Ç–º–µ–Ω—ë–Ω";}
          else status.textContent="–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω";
          top.appendChild(dSpan);
          top.appendChild(status);

          const meta=document.createElement("div");
          meta.className="lesson-meta";
          meta.textContent=l.topic || "–¢–µ–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞";

          item.appendChild(top);
          item.appendChild(meta);
          list.appendChild(item);
        });
    }

    card.appendChild(list);
    main.appendChild(card);
  }

  function openEditStudent(id){
    currentView="editStudent";
    currentStudentId=id;
    render();
  }

  function renderEditStudent(main,id){
    const st=getStudent(id);
    if(!st){
      const card=document.createElement("section");
      card.className="card";card.textContent="–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.";main.appendChild(card);return;
    }
    const card=document.createElement("section");
    card.className="card";
    const header=document.createElement("div");
    header.className="card-header";
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–ò–∑–º–µ–Ω–∏—Ç—å —É—á–µ–Ω–∏–∫–∞";
    header.appendChild(title);
    card.appendChild(header);

    const form=document.createElement("div");
    form.className="form-section";

    const row1=document.createElement("div");
    row1.className="form-row-inline";
    const colName=document.createElement("div");
    const lblName=document.createElement("div");
    lblName.className="form-label";lblName.textContent="–§–ò —É—á–µ–Ω–∏–∫–∞";
    const inName=document.createElement("input");
    inName.className="form-input";inName.value=st.name;
    colName.appendChild(lblName);colName.appendChild(inName);
    const colContact=document.createElement("div");
    const lblC=document.createElement("div");
    lblC.className="form-label";lblC.textContent="–ö–æ–Ω—Ç–∞–∫—Ç —É—á–µ–Ω–∏–∫–∞";
    const inContact=document.createElement("input");
    inContact.className="form-input";inContact.value=st.contact||"";
    colContact.appendChild(lblC);colContact.appendChild(inContact);
    row1.appendChild(colName);row1.appendChild(colContact);

    const rowParent=document.createElement("div");
    rowParent.className="form-row-inline";
    const colPName=document.createElement("div");
    const lblPName=document.createElement("div");
    lblPName.className="form-label";lblPName.textContent="–§–ò —Ä–æ–¥–∏—Ç–µ–ª—è";
    const inPName=document.createElement("input");
    inPName.className="form-input";inPName.value=st.parentName||"";
    colPName.appendChild(lblPName);colPName.appendChild(inPName);
    const colPContact=document.createElement("div");
    const lblPContact=document.createElement("div");
    lblPContact.className="form-label";lblPContact.textContent="–ö–æ–Ω—Ç–∞–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª—è";
    const inPContact=document.createElement("input");
    inPContact.className="form-input";inPContact.value=st.parentContact||"";
    colPContact.appendChild(lblPContact);colPContact.appendChild(inPContact);
    rowParent.appendChild(colPName);rowParent.appendChild(colPContact);

    const row2=document.createElement("div");
    row2.className="form-row-inline";
    const colCT=document.createElement("div");
    const lblCT=document.createElement("div");
    lblCT.className="form-label";lblCT.textContent="–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞ —É—á–µ–Ω–∏–∫–∞";
    const selCT=document.createElement("select");
    selCT.className="form-select";
    [["phone","—Ç–µ–ª–µ—Ñ–æ–Ω"],["whatsapp","WhatsApp"],["telegram","Telegram"]].forEach(([val,txt])=>{
      const opt=document.createElement("option");
      opt.value=val;opt.textContent=txt;
      if(val===st.contactType) opt.selected=true;
      selCT.appendChild(opt);
    });
    colCT.appendChild(lblCT);colCT.appendChild(selCT);

    const colPCT=document.createElement("div");
    const lblPCT=document.createElement("div");
    lblPCT.className="form-label";lblPCT.textContent="–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—è";
    const selPCT=document.createElement("select");
    selPCT.className="form-select";
    [["phone","—Ç–µ–ª–µ—Ñ–æ–Ω"],["whatsapp","WhatsApp"],["telegram","Telegram"]].forEach(([val,txt])=>{
      const opt=document.createElement("option");
      opt.value=val;opt.textContent=txt;
      if(val===st.parentContactType) opt.selected=true;
      selPCT.appendChild(opt);
    });
    colPCT.appendChild(lblPCT);colPCT.appendChild(selPCT);

    const colTZ=document.createElement("div");
    const lblTZ=document.createElement("div");
    lblTZ.className="form-label";lblTZ.textContent="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —É—á–µ–Ω–∏–∫–∞";
    const selTZ=document.createElement("select");
    selTZ.className="form-select";
    ALL_TZ.forEach(tz=>{
      const opt=document.createElement("option");
      opt.value=tz;opt.textContent=tz;
      if(tz===st.tz) opt.selected=true;
      selTZ.appendChild(opt);
    });
    colTZ.appendChild(lblTZ);colTZ.appendChild(selTZ);

    row2.appendChild(colCT);row2.appendChild(colPCT);row2.appendChild(colTZ);

    const rowNotes=document.createElement("div");
    rowNotes.className="form-row";
    const lblN=document.createElement("div");
    lblN.className="form-label";lblN.textContent="–ó–∞–º–µ—Ç–∫–∏";
    const inNotes=document.createElement("textarea");
    inNotes.value=st.notes||"";
    rowNotes.appendChild(lblN);rowNotes.appendChild(inNotes);

    const actions=document.createElement("div");
    actions.className="form-actions";
    const btnSave=document.createElement("button");
    btnSave.className="btn-main";
    btnSave.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    btnSave.onclick=()=>{
      st.name=inName.value.trim();
      st.contact=inContact.value.trim();
      st.contactType=selCT.value;
      st.parentName=inPName.value.trim();
      st.parentContact=inPContact.value.trim();
      st.parentContactType=selPCT.value;
      st.tz=selTZ.value;
      st.notes=inNotes.value;
      save();
      currentView="student";
      render();
    };

    const btnCancel=document.createElement("button");
    btnCancel.className="btn-secondary";
    btnCancel.textContent="–û—Ç–º–µ–Ω–∞";
    btnCancel.onclick=()=>{
      currentView="student";
      render();
    };
    actions.appendChild(btnSave);actions.appendChild(btnCancel);

    form.appendChild(row1);
    form.appendChild(rowParent);
    form.appendChild(row2);
    form.appendChild(rowNotes);
    form.appendChild(actions);

    card.appendChild(form);
    main.appendChild(card);
  }

  /* ---------- LESSON VIEW ---------- */

  function openLessonView(id){
    currentView="lesson";
    currentLessonId=id;
    render();
  }

  function renderLesson(main,id){
    const l=data.lessons.find(x=>x.id===id);
    if(!l){
      const card=document.createElement("section");
      card.className="card";card.textContent="–£—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.";main.appendChild(card);return;
    }
    const st=getStudent(l.studentId);
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent = st? st.name : "–£—á–µ–Ω–∏–∫";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent = `${l.date} ‚Ä¢ ${l.time}`;
    left.appendChild(title);left.appendChild(subtitle);

    const btnBack=document.createElement("button");
    btnBack.className="btn-secondary";
    btnBack.textContent="‚Üê –ù–∞–∑–∞–¥";
    btnBack.onclick=()=>{currentView="today";render();};

    header.appendChild(left);
    header.appendChild(btnBack);
    card.appendChild(header);

    const form=document.createElement("div");
    form.className="form-section";

    const rowTopic=document.createElement("div");
    rowTopic.className="form-row";
    const lblTopic=document.createElement("div");
    lblTopic.className="form-label";lblTopic.textContent="–¢–µ–º–∞ –∑–∞–Ω—è—Ç–∏—è";
    const inTopic=document.createElement("input");
    inTopic.className="form-input";inTopic.value=l.topic||"";
    rowTopic.appendChild(lblTopic);rowTopic.appendChild(inTopic);

    const rowHW=document.createElement("div");
    rowHW.className="form-row";
    const lblHW=document.createElement("div");
    lblHW.className="form-label";lblHW.textContent="–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ";
    const inHW=document.createElement("textarea");
    inHW.value=l.hw||"";
    rowHW.appendChild(lblHW);rowHW.appendChild(inHW);

    let gradeLessonVal = l.gradeLesson;
    let gradeHWVal = l.gradeHW;

    function setLessonGrade(v){ gradeLessonVal = v; }
    function setHWGrade(v){ gradeHWVal = v; }

    function makeGradeSelector(label,isLesson){
      const wrap=document.createElement("div");
      wrap.className="form-row";
      const lbl=document.createElement("div");
      lbl.className="form-label";
      lbl.textContent=label;
      const row=document.createElement("div");
      row.style.display="flex";
      row.style.gap="4px";
      const values=[2,3,4,5];
      const buttons=[];
      const btnNone=document.createElement("button");
      btnNone.type="button";
      btnNone.className="btn-chip small";
      btnNone.textContent="‚Äî";

      function currentValue(){
        return isLesson ? gradeLessonVal : gradeHWVal;
      }

      function setValue(v){
        if(isLesson) setLessonGrade(v);
        else setHWGrade(v);
        updateActive();
      }

      values.forEach(v=>{
        const btn=document.createElement("button");
        btn.type="button";
        btn.className="btn-chip small";
        btn.textContent=String(v);
        btn.onclick=()=>setValue(v);
        buttons.push(btn);
        row.appendChild(btn);
      });

      btnNone.onclick=()=>setValue(null);
      row.appendChild(btnNone);

      function updateActive(){
        buttons.forEach(b=>{
          b.style.background="var(--card)";
          b.style.color="var(--text)";
        });
        btnNone.style.background="var(--card)";
        btnNone.style.color="var(--text)";
        const val=currentValue();
        if(val==null){
          btnNone.style.background="var(--accent-soft)";
        } else {
          const idx=values.indexOf(val);
          if(idx>=0){
            buttons[idx].style.background="var(--accent)";
            buttons[idx].style.color="#fff";
          }
        }
      }
      setTimeout(updateActive,0);

      wrap.appendChild(lbl);
      wrap.appendChild(row);
      return wrap;
    }

    const rowGradesWrap=document.createElement("div");
    rowGradesWrap.className="form-row-inline";
    const colGL=document.createElement("div");
    const colGH=document.createElement("div");
    colGL.appendChild(makeGradeSelector("–û—Ü–µ–Ω–∫–∞ –∑–∞ —É—Ä–æ–∫",true));
    colGH.appendChild(makeGradeSelector("–û—Ü–µ–Ω–∫–∞ –∑–∞ –¥–æ–º–∞—à–Ω—é—é —Ä–∞–±–æ—Ç—É",false));
    rowGradesWrap.appendChild(colGL);
    rowGradesWrap.appendChild(colGH);

    const rowGradeComments=document.createElement("div");
    rowGradeComments.className="form-row-inline";

    const colCL=document.createElement("div");
    const lblCL=document.createElement("div");
    lblCL.className="form-label";lblCL.textContent="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ –∑–∞ —É—Ä–æ–∫";
    const inCL=document.createElement("textarea");
    inCL.value=l.commentLesson || "";
    colCL.appendChild(lblCL);colCL.appendChild(inCL);

    const colCH=document.createElement("div");
    const lblCH=document.createElement("div");
    lblCH.className="form-label";lblCH.textContent="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ –∑–∞ –¥–æ–º–∞—à–Ω—é—é —Ä–∞–±–æ—Ç—É";
    const inCH=document.createElement("textarea");
    inCH.value=l.commentHW || "";
    colCH.appendChild(lblCH);colCH.appendChild(inCH);

    rowGradeComments.appendChild(colCL);
    rowGradeComments.appendChild(colCH);

    const rowComment=document.createElement("div");
    rowComment.className="form-row";
    const lblComment=document.createElement("div");
    lblComment.className="form-label";lblComment.textContent="–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —Å–µ–±—è/—Ä–æ–¥–∏—Ç–µ–ª–µ–π";
    const inComment=document.createElement("textarea");
    inComment.value=l.comment||"";
    rowComment.appendChild(lblComment);rowComment.appendChild(inComment);

    const actions=document.createElement("div");
    actions.className="form-actions";

    const btnSave=document.createElement("button");
    btnSave.className="btn-main";
    btnSave.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    btnSave.onclick=()=>{
      l.topic=inTopic.value;
      l.hw=inHW.value;
      l.gradeLesson = gradeLessonVal;
      l.gradeHW = gradeHWVal;
      l.commentLesson = inCL.value;
      l.commentHW = inCH.value;
      l.comment=inComment.value;
      save();
    };

    const btnDone=document.createElement("button");
    btnDone.className="btn-secondary";
    btnDone.textContent="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ–≤–µ–¥—ë–Ω";
    btnDone.onclick=()=>{l.status="done";save();};

    const btnCancel=document.createElement("button");
    btnCancel.className="btn-danger";
    btnCancel.textContent="–û—Ç–º–µ–Ω–∏—Ç—å —É—Ä–æ–∫";
    btnCancel.onclick=()=>{l.status="cancelled";save();};

    const btnRem=document.createElement("button");
    btnRem.className="btn-secondary";
    btnRem.textContent="–ù–∞–ø–æ–º–Ω–∏—Ç—å –æ –∑–∞–Ω—è—Ç–∏–∏";
    btnRem.onclick=()=>sendLessonReminder(l,st);

    const btnHW=document.createElement("button");
    btnHW.className="btn-secondary";
    btnHW.textContent="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–º–∞—à–∫—É";
    btnHW.onclick=()=>sendHomework(l,st);

    actions.appendChild(btnSave);
    actions.appendChild(btnDone);
    actions.appendChild(btnCancel);
    actions.appendChild(btnRem);
    actions.appendChild(btnHW);

    form.appendChild(rowTopic);
    form.appendChild(rowHW);
    form.appendChild(rowGradesWrap);
    form.appendChild(rowGradeComments);
    form.appendChild(rowComment);
    form.appendChild(actions);

    card.appendChild(form);
    main.appendChild(card);
  }

  /* ---------- MESSENGERS ---------- */

  function sendLessonReminder(lesson,student){
    if(!student){alert("–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");return;}
    const text=`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ üåø\n–°–µ–≥–æ–¥–Ω—è –∑–∞–Ω—è—Ç–∏–µ –≤ ${lesson.time}.\n–¢–µ–º–∞: ${lesson.topic||"(—É—Ç–æ—á–Ω–∏–º –Ω–∞ —É—Ä–æ–∫–µ)"}`;
    openMessenger(student,text);
  }

  function sendHomework(lesson,student){
    if(!student){alert("–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");return;}
    const text=`–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ üìö\n${lesson.hw||"–°–∫–æ—Ä–æ –ø—Ä–∏—à–ª—é –∑–∞–¥–∞–Ω–∏–µ."}`;
    openMessenger(student,text);
  }

  // —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—é –ø—Ä–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç
  function notifySubscription(student, stats){
    const {remaining,total,price,paid,doneCount} = stats;
    let text;
    if(total>0 && remaining<=0){
      text =
        `–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –£ ${student.name} –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç `+
        `(${total} –∑–∞–Ω—è—Ç–∏–π, –ø—Ä–æ–≤–µ–¥–µ–Ω–æ ${doneCount}). `+
        `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ–ø–ª–∞—Ç—É. –°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} ‚ÇΩ, –æ–ø–ª–∞—á–µ–Ω–æ: ${paid} ‚ÇΩ.`;
    } else if(total>0 && remaining<=2){
      text =
        `–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –£ ${student.name} —Å–∫–æ—Ä–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç. `+
        `–û—Å—Ç–∞–ª–æ—Å—å ${remaining} –∑–∞–Ω—è—Ç–∏–π –∏–∑ ${total}.`;
    } else {
      text =
        `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É ${student.name}: –ø—Ä–æ–≤–µ–¥–µ–Ω–æ ${doneCount} –∏–∑ ${total} –∑–∞–Ω—è—Ç–∏–π.`;
    }
    openParentMessenger(student,text);
  }

  function openMessenger(student,text){
    if(!student.contact){
      alert("–£ —É—á–µ–Ω–∏–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ–Ω—Ç–∞–∫—Ç.");
      return;
    }
    openMessengerBy(student.contactType || "phone", student.contact, text);
  }

  function openParentMessenger(student,text){
    let type = student.parentContactType || "phone";
    let contact = (student.parentContact || "").trim();
    if(!contact){
      // –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—è ‚Äî –ø—Ä–æ–±—É–µ–º —É—á–µ–Ω–∏–∫–∞
      type = student.contactType || "phone";
      contact = (student.contact || "").trim();
    }
    if(!contact){
      alert("–ù–µ —É–∫–∞–∑–∞–Ω –∫–æ–Ω—Ç–∞–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ —É—á–µ–Ω–∏–∫–∞.");
      return;
    }
    openMessengerBy(type, contact, text);
  }

  function openMessengerBy(type, contact, text){
    const c = (contact || "").trim();
    if(!c){
      alert("–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω.");
      return;
    }
    const msg = encodeURIComponent(text);
    if(type==="whatsapp"){
      const phone=c.replace(/^\+/,"");
      window.open(`https://wa.me/${phone}?text=${msg}`,"_blank");
    } else if(type==="telegram"){
      const uname=c.startsWith("@")?c.substring(1):c;
      window.open(`https://t.me/${uname}?text=${msg}`,"_blank");
    } else {
      alert("–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω. –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:\n\n"+text);
    }
  }

  /* ---------- SUBSCRIPTIONS MAIN VIEW ---------- */

  function renderSubscriptions(main){
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–°–∫–æ–ª—å–∫–æ —É—Ä–æ–∫–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å, –∫—Ç–æ –æ–ø–ª–∞—Ç–∏–ª –∏ –∫–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞.";
    left.appendChild(title);
    left.appendChild(subtitle);

    const btnBack=document.createElement("button");
    btnBack.className="btn-secondary";
    btnBack.textContent="–ö —É—á–µ–Ω–∏–∫–∞–º";
    btnBack.onclick=()=>{currentView="students";render();};

    header.appendChild(left);
    header.appendChild(btnBack);
    card.appendChild(header);

    if (!data.students.length){
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–ü–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤.";
      card.appendChild(empty);
      main.appendChild(card);
      return;
    }

    const headerRow=document.createElement("div");
    headerRow.className="subs-table-header";
    headerRow.innerHTML=
      "<span>–£—á–µ–Ω–∏–∫</span>"+
      "<span>–û–ø–ª–∞—á–µ–Ω–æ / —Ü–µ–Ω–∞</span>"+
      "<span>–ü—Ä–æ—à–ª–∏ / –≤—Å–µ–≥–æ</span>"+
      "<span>–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç–∏–π</span>"+
      "<span>–°–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞</span>"+
      "<span>–°—Ç–∞—Ç—É—Å / –¥–µ–π—Å—Ç–≤–∏—è</span>";
    card.appendChild(headerRow);

    data.students.forEach(st=>{
      const stats = getSubscriptionStats(st.id);
      const {sub,doneCount,total,remaining,price,paid,debt} = stats;

      let statusText="";
      if(!sub){
        statusText="–Ω–µ—Ç –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞";
      } else if (debt>0){
        statusText=`–¥–æ–ª–≥ ${debt} ‚ÇΩ`;
      } else if (remaining<=2 && total>0){
        statusText="—Å–∫–æ—Ä–æ –∫–æ–Ω—á–∏—Ç—Å—è";
      } else {
        statusText="OK";
      }

      const row=document.createElement("div");
      row.className="subs-table-row";

      const c1=document.createElement("div");
      c1.textContent=st.name;

      const c2=document.createElement("div");
      c2.textContent=sub?`${paid}/${price} ‚ÇΩ`:"‚Äî";

      const c3=document.createElement("div");
      c3.textContent=sub?`${doneCount}/${total}`:"‚Äî";

      const c4=document.createElement("div");
      c4.textContent=sub?remaining:"‚Äî";

      const c5=document.createElement("div");
      c5.textContent=sub && sub.nextPaymentDate ? sub.nextPaymentDate : "‚Äî";

      const c6=document.createElement("div");
      c6.style.display="flex";
      c6.style.alignItems="center";
      c6.style.gap="4px";
      const statusSpan=document.createElement("span");
      statusSpan.className="tiny";
      statusSpan.textContent=statusText;

      const btnEdit=document.createElement("button");
      btnEdit.className="btn-chip small";
      btnEdit.textContent="–ò–∑–º–µ–Ω–∏—Ç—å";
      btnEdit.onclick=()=>editSubscription(st.id);

      const btnNotify=document.createElement("button");
      btnNotify.className="btn-chip small primary";
      btnNotify.textContent="–û–ø–æ–≤–µ—Å—Ç–∏—Ç—å";
      btnNotify.onclick=()=>notifySubscription(st, stats);

      c6.appendChild(statusSpan);
      c6.appendChild(btnEdit);
      c6.appendChild(btnNotify);

      row.appendChild(c1);
      row.appendChild(c2);
      row.appendChild(c3);
      row.appendChild(c4);
      row.appendChild(c5);
      row.appendChild(c6);

      card.appendChild(row);
    });

    main.appendChild(card);
  }

  /* ---------- SUBSCRIPTION EDIT VIEW ---------- */

  function renderSubscriptionEdit(main,studentId){
    const st=getStudent(studentId);
    if(!st){
      const card=document.createElement("section");
      card.className="card";
      card.textContent="–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.";
      main.appendChild(card);
      return;
    }
    let stats = getSubscriptionStats(studentId);
    let sub = stats.sub;
    if(!sub){
      const newId=data.subscriptions.length?Math.max(...data.subscriptions.map(s=>s.id))+1:1;
      sub={id:newId,studentId,total:0,price:0,paid:0,nextPaymentDate:"",doneOffset:0};
      data.subscriptions.push(sub);
      save();
      stats = getSubscriptionStats(studentId);
      sub = stats.sub;
    }

    const {rawDone,doneCount,total,price,paid} = stats;

    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent=`–ê–±–æ–Ω–µ–º–µ–Ω—Ç: ${st.name}`;
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–Ω—è—Ç–∏–π.";
    left.appendChild(title);
    left.appendChild(subtitle);

    const btnBack=document.createElement("button");
    btnBack.className="btn-secondary";
    btnBack.textContent="‚Üê –ö —É—á–µ–Ω–∏–∫—É";
    btnBack.onclick=()=>{currentView="student";currentStudentId=studentId;render();};

    header.appendChild(left);
    header.appendChild(btnBack);
    card.appendChild(header);

    const form=document.createElement("div");
    form.className="form-section";

    const row1=document.createElement("div");
    row1.className="form-row-inline";

    const colPrice=document.createElement("div");
    const lblPrice=document.createElement("div");
    lblPrice.className="form-label";
    lblPrice.textContent="–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ (‚ÇΩ)";
    const inPrice=document.createElement("input");
    inPrice.className="form-input";
    inPrice.type="number";
    inPrice.min="0";
    inPrice.value=price || 0;
    colPrice.appendChild(lblPrice);
    colPrice.appendChild(inPrice);

    const colPaid=document.createElement("div");
    const lblPaid=document.createElement("div");
    lblPaid.className="form-label";
    lblPaid.textContent="–û–ø–ª–∞—á–µ–Ω–æ (‚ÇΩ)";
    const inPaid=document.createElement("input");
    inPaid.className="form-input";
    inPaid.type="number";
    inPaid.min="0";
    inPaid.value=paid || 0;
    colPaid.appendChild(lblPaid);
    colPaid.appendChild(inPaid);

    row1.appendChild(colPrice);
    row1.appendChild(colPaid);

    const row2=document.createElement("div");
    row2.className="form-row-inline";

    const colTotal=document.createElement("div");
    const lblTotal=document.createElement("div");
    lblTotal.className="form-label";
    lblTotal.textContent="–ó–∞–Ω—è—Ç–∏–π –≤ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–µ";
    const inTotal=document.createElement("input");
    inTotal.className="form-input";
    inTotal.type="number";
    inTotal.min="0";
    inTotal.value=total || 0;
    colTotal.appendChild(lblTotal);
    colTotal.appendChild(inTotal);

    const colNext=document.createElement("div");
    const lblNext=document.createElement("div");
    lblNext.className="form-label";
    lblNext.textContent="–°–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞ (–¥–∞—Ç–∞)";
    const inNext=document.createElement("input");
    inNext.className="form-input";
    inNext.type="date";
    inNext.value=sub.nextPaymentDate || "";
    colNext.appendChild(lblNext);
    colNext.appendChild(inNext);

    row2.appendChild(colTotal);
    row2.appendChild(colNext);

    const rowDone=document.createElement("div");
    rowDone.className="form-row";
    const lblDone=document.createElement("div");
    lblDone.className="form-label";
    lblDone.textContent="–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–π (–≤—Å–µ–≥–æ, –≤–∫–ª—é—á–∞—è –ø—Ä–æ—à–ª—ã–µ)";
    const inDone=document.createElement("input");
    inDone.className="form-input";
    inDone.type="number";
    inDone.min="0";
    inDone.value=doneCount;
    const hint=document.createElement("div");
    hint.className="tiny";
    hint.textContent=`–°–µ–π—á–∞—Å –ø–æ —É—Ä–æ–∫–∞–º –ø—Ä–æ–≤–µ–¥–µ–Ω–æ ${rawDone}. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ –¥–æ—Å—á–∏—Ç–∞—Ç—å —Ä—É–∫–∞–º–∏ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–Ω—è—Ç–∏–π.`;
    rowDone.appendChild(lblDone);
    rowDone.appendChild(inDone);
    rowDone.appendChild(hint);

    const actions=document.createElement("div");
    actions.className="form-actions";
    const btnSave=document.createElement("button");
    btnSave.className="btn-main";
    btnSave.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    btnSave.onclick=()=>{
      sub.price = inPrice.value ? parseFloat(inPrice.value) : 0;
      sub.paid = inPaid.value ? parseFloat(inPaid.value) : 0;
      sub.total = inTotal.value ? parseInt(inTotal.value,10) : 0;
      sub.nextPaymentDate = inNext.value || "";

      const manualDone = inDone.value ? parseInt(inDone.value,10) : 0;
      const offset = manualDone - rawDone;
      sub.doneOffset = offset>0 ? offset : 0;

      save();
      currentView="student";
      currentStudentId=studentId;
      render();
    };

    const btnCancel=document.createElement("button");
    btnCancel.className="btn-secondary";
    btnCancel.textContent="–û—Ç–º–µ–Ω–∞";
    btnCancel.onclick=()=>{
      currentView="student";
      currentStudentId=studentId;
      render();
    };

    actions.appendChild(btnSave);
    actions.appendChild(btnCancel);

    form.appendChild(row1);
    form.appendChild(row2);
    form.appendChild(rowDone);
    form.appendChild(actions);

    card.appendChild(form);
    main.appendChild(card);
  }

  /* ---------- –ñ–£–†–ù–ê–õ ---------- */

  function renderJournal(main){
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–ñ—É—Ä–Ω–∞–ª";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–Ω—è—Ç–∏—è–º: –¥–∞—Ç—ã, –æ—Ü–µ–Ω–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.";
    left.appendChild(title);
    left.appendChild(subtitle);
    header.appendChild(left);
    card.appendChild(header);

    if(!data.students.length){
      const empty=document.createElement("div");
      empty.className="empty-state";
      empty.textContent="–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤.";
      card.appendChild(empty);
      main.appendChild(card);
      return;
    }

    const filterRow=document.createElement("div");
    filterRow.className="form-row-inline";
    const colSel=document.createElement("div");
    const lblSel=document.createElement("div");
    lblSel.className="form-label";
    lblSel.textContent="–£—á–µ–Ω–∏–∫";
    const sel=document.createElement("select");
    sel.className="form-select";
    const optAll=document.createElement("option");
    optAll.value="all";
    optAll.textContent="–í—Å–µ —É—á–µ–Ω–∏–∫–∏";
    sel.appendChild(optAll);
    data.students.forEach(st=>{
      const opt=document.createElement("option");
      opt.value=String(st.id);
      opt.textContent=st.name;
      sel.appendChild(opt);
    });
    sel.value = journalFilterStudentId;
    sel.onchange=()=>{
      journalFilterStudentId = sel.value;
      render();
    };
    colSel.appendChild(lblSel);
    colSel.appendChild(sel);
    filterRow.appendChild(colSel);
    card.appendChild(filterRow);

    const container=document.createElement("div");
    container.style.display="flex";
    container.style.flexDirection="column";
    container.style.gap="8px";
    container.style.marginTop="8px";

    const studentsToShow = journalFilterStudentId==="all"
      ? data.students
      : data.students.filter(s=>String(s.id)===journalFilterStudentId);

    studentsToShow.forEach(st=>{
      const lessons = getLessonsByStudent(st.id)
        .slice()
        .sort((a,b)=> a.date===b.date ? a.time.localeCompare(b.time) : a.date.localeCompare(b.date));

      const block=document.createElement("div");
      block.className="form-section";

      const t=document.createElement("div");
      t.className="card-title";
      t.style.fontSize="13px";
      t.textContent=st.name;
      block.appendChild(t);

      if(!lessons.length){
        const empty=document.createElement("div");
        empty.className="tiny";
        empty.textContent="–£—Ä–æ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.";
        block.appendChild(empty);
      } else {
        const headerRow=document.createElement("div");
        headerRow.style.display="grid";
        headerRow.style.gridTemplateColumns="1.4fr 1fr 1fr 2fr";
        headerRow.style.columnGap="4px";
        headerRow.style.fontSize="11px";
        headerRow.style.fontWeight="600";
        headerRow.style.color="var(--muted)";
        headerRow.style.borderBottom="1px solid var(--border)";
        headerRow.style.paddingBottom="2px";
        headerRow.innerHTML="<span>–î–∞—Ç–∞ –∏ —Ç–µ–º–∞</span><span>–û—Ü–µ–Ω–∫–∏</span><span>–°—Ç–∞—Ç—É—Å</span><span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>";
        block.appendChild(headerRow);

        lessons.forEach(l=>{
          const row=document.createElement("div");
          row.style.display="grid";
          row.style.gridTemplateColumns="1.4fr 1fr 1fr 2fr";
          row.style.columnGap="4px";
          row.style.fontSize="11px";
          row.style.padding="2px 0";
          row.style.borderBottom="1px solid rgba(0,0,0,0.03)";

          const c1=document.createElement("div");
          c1.innerHTML = `<strong>${l.date}</strong> ${l.time}<br><span class="tiny">${l.topic || "‚Äî"}</span>`;

          const c2=document.createElement("div");
          const gl = l.gradeLesson!=null ? l.gradeLesson : "‚Äî";
          const gh = l.gradeHW!=null ? l.gradeHW : "‚Äî";
          c2.innerHTML = `–£—Ä–æ–∫: ${gl}<br>–î/–∑: ${gh}`;

          const c3=document.createElement("div");
          let stText="";
          if(l.status==="done") stText="–ø—Ä–æ–≤–µ–¥—ë–Ω";
          else if(l.status==="cancelled") stText="–æ—Ç–º–µ–Ω—ë–Ω";
          else stText="–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω";
          c3.textContent=stText;

          const c4=document.createElement("div");
          const parts=[];
          if(l.commentLesson) parts.push(`–£—Ä–æ–∫: ${l.commentLesson}`);
          if(l.commentHW) parts.push(`–î/–∑: ${l.commentHW}`);
          if(l.comment && !l.commentLesson && !l.commentHW) parts.push(l.comment);
          c4.textContent = parts.join(" | ") || "‚Äî";

          row.appendChild(c1);
          row.appendChild(c2);
          row.appendChild(c3);
          row.appendChild(c4);

          block.appendChild(row);
        });
      }

      container.appendChild(block);
    });

    card.appendChild(container);
    main.appendChild(card);
  }

  /* ---------- SETTINGS & LOGOUT ---------- */

  function renderSettings(main){
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–ù–∞—Å—Ç—Ä–æ–π–∫–∏";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏.";
    left.appendChild(title);
    left.appendChild(subtitle);
    header.appendChild(left);
    card.appendChild(header);

    const block=document.createElement("div");
    block.className="form-section";

    const tzRow=document.createElement("div");
    tzRow.className="form-row";
    const lbl=document.createElement("div");
    lbl.className="form-label";
    lbl.textContent="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è";
    const sel=document.createElement("select");
    sel.className="form-select";
    ALL_TZ.forEach(tz=>{
      const opt=document.createElement("option");
      opt.value=tz;opt.textContent=tz;
      if(tz===data.tutorTZ) opt.selected=true;
      sel.appendChild(opt);
    });
    sel.onchange=()=>{
      data.tutorTZ=sel.value;
      save();
    };
    tzRow.appendChild(lbl);
    tzRow.appendChild(sel);

    const danger=document.createElement("div");
    danger.className="form-section";
    danger.style.background="#f7d1d5";
    danger.style.borderColor="#e4a7af";

    const dTitle=document.createElement("div");
    dTitle.className="card-title";
    dTitle.style.fontSize="13px";
    dTitle.textContent="–°–±—Ä–æ—Å–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç";
    const dText=document.createElement("div");
    dText.className="tiny";
    dText.textContent="–£–¥–∞–ª–∏—Ç –≤—Å–µ—Ö —É—á–µ–Ω–∏–∫–æ–≤, —É—Ä–æ–∫–∏ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞. –ù–∞–∑–∞–¥ –≤–µ—Ä–Ω—É—Ç—å –Ω–µ–ª—å–∑—è.";
    const btnReset=document.createElement("button");
    btnReset.className="btn-danger";
    btnReset.textContent="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ";
    btnReset.onclick=()=>{
      if(confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (—É—á–µ–Ω–∏–∫–æ–≤, —É—Ä–æ–∫–∏, –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã)?")) {
        localStorage.removeItem(STORAGE_KEY);
        data = loadData();
        render();
      }
    };

    danger.appendChild(dTitle);
    danger.appendChild(dText);
    danger.appendChild(btnReset);

    block.appendChild(tzRow);
    card.appendChild(block);
    card.appendChild(danger);

    main.appendChild(card);
  }

  function renderLogout(main){
    const card=document.createElement("section");
    card.className="card";

    const header=document.createElement("div");
    header.className="card-header";
    const title=document.createElement("div");
    title.className="card-title";
    title.textContent="–í—ã—Ö–æ–¥";
    const subtitle=document.createElement("div");
    subtitle.className="card-subtitle";
    subtitle.textContent="–í –æ—Ñ–ª–∞–π–Ω-–≤–µ—Ä—Å–∏–∏ –ª–æ–≥–∏–Ω–∞ –Ω–µ—Ç ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–≤–æ–π –∫–∞–±–∏–Ω–µ—Ç.";
    header.appendChild(title);
    header.appendChild(subtitle);
    card.appendChild(header);

    const text=document.createElement("div");
    text.className="tiny";
    text.innerHTML =
      "–°–µ–π—á–∞—Å –∫–∞–±–∏–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ª–∏—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. "+
      "–ß—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –±–æ–ª—å—à–µ –Ω–µ –≤–∏–¥–µ–ª –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–∞–≤–∞–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É/–±—Ä–∞—É–∑–µ—Ä—É. "+
      "–ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –æ–Ω–ª–∞–π–Ω-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –∑–¥–µ—Å—å –±—É–¥–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞.";

    card.appendChild(text);
    main.appendChild(card);
  }

  /* ---------- ROOT RENDER ---------- */

  const mainCol=document.getElementById("mainCol");
  const navBtns=document.querySelectorAll(".nav-btn");

  navBtns.forEach(btn=>{
    btn.onclick=()=>{
      navBtns.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentView=btn.dataset.view;
      render();
    };
  });

  function render(){
    renderHeaderInfo();
    mainCol.innerHTML="";
    if(currentView==="today") renderToday(mainCol);
    else if(currentView==="calendar") renderCalendar(mainCol);
    else if(currentView==="students") renderStudents(mainCol);
    else if(currentView==="student") renderStudent(mainCol,currentStudentId);
    else if(currentView==="editStudent") renderEditStudent(mainCol,currentStudentId);
    else if(currentView==="lesson") renderLesson(mainCol,currentLessonId);
    else if(currentView==="subscriptions") renderSubscriptions(mainCol);
    else if(currentView==="subscriptionEdit") renderSubscriptionEdit(mainCol,currentSubscriptionStudentId);
    else if(currentView==="journal") renderJournal(mainCol);
    else if(currentView==="settings") renderSettings(mainCol);
    else if(currentView==="logout") renderLogout(mainCol);
  }

  render();
</script>
</body>
</html>

